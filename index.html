<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Initiative Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/a71c865768.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* General Setup */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Dark background */
        }
        .container-card {
            background-color: #374151; /* Medium dark card */
            border-radius: 1.5rem; /* Larger rounded corners for tablet */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);
        }
        
        /* D20 Roller */
        .d20 {
            transition: transform 0.1s ease-out;
            cursor: pointer;
            user-select: none;
        }
        .d20:active {
            transform: scale(0.95) rotate(5deg);
        }
        .d20-face {
            clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
            border: 4px solid rgba(255, 255, 255, 0.2);
        }

        /* Loading */
        .loading-animation {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #4ade80;
            border-radius: 50%;
            width: 32px; /* Bigger for visibility */
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Stat Block Divider */
        .stat-divider {
            height: 5px;
            background: linear-gradient(to right, #4b5563, #374151, #4b5563);
            margin: 0.75rem 0; /* More spacing */
            border-radius: 5px;
        }

        /* Initiative List Highlights */
        .current-turn-highlight {
            border: 3px solid #fcd34d; /* Thicker Amber border */
            transform: scale(1.02);
            box-shadow: 0 0 12px rgba(252, 211, 77, 0.6);
        }
        
        /* Input & Button Adjustments for Touch */
        .touch-input {
            padding: 0.75rem; /* Increased vertical padding */
            font-size: 1rem;
        }
        .hp-button {
            width: 3rem; 
            height: 3rem;
            font-size: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            transition: all 0.1s ease;
        }
        .hp-button:active {
            transform: scale(0.9);
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 md:p-10 text-gray-100">

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center">
        <div class="loading-animation"></div>
        <p class="ml-4 text-xl font-semibold text-white">Connecting to the Great Beyond...</p>
    </div>

    <div class="max-w-7xl mx-auto space-y-8">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-center text-green-400 mb-8">
            Dungeon Master Combat Console
        </h1>

        <!-- Top Section: D20 Roller and Add Character Form -->
        <div class="container-card p-6 sm:p-8 mb-8 flex flex-col lg:flex-row items-center justify-between">
            <!-- D20 Roller -->
            <div class="flex flex-col items-center justify-center w-full lg:w-1/4 p-4 mb-6 lg:mb-0">
                <div id="d20-roller" class="d20 d20-face bg-green-600 hover:bg-green-500 w-40 h-40 flex items-center justify-center text-white font-extrabold text-7xl shadow-xl transition-all duration-300 transform hover:scale-105" onclick="rollD20()">
                    ?
                </div>
                <p id="d20-result-text" class="mt-4 text-xl font-semibold text-green-300">Click to Roll</p>
                <p id="user-id-display" class="mt-2 text-sm text-gray-400 text-center">Collaboration ID: Loading...</p>
            </div>

            <!-- Add Character Form (for custom/PC entry) -->
            <div class="w-full lg:w-3/4 lg:pl-8">
                <h2 class="text-3xl font-bold mb-4 text-white">Add PC / Custom NPC</h2>
                <form id="add-character-form" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
                        <input type="text" id="char-name" placeholder="Character Name" required class="col-span-1 sm:col-span-2 bg-gray-700 text-white touch-input rounded-xl focus:ring-green-500 focus:border-green-500 border border-transparent">
                        <input type="number" id="char-hp" placeholder="HP Max" required class="bg-gray-700 text-white touch-input rounded-xl focus:ring-green-500 focus:border-green-500 border border-transparent">
                        <input type="number" id="char-ac" placeholder="AC" required class="bg-gray-700 text-white touch-input rounded-xl focus:ring-green-500 focus:border-green-500 border border-transparent">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="char-initiative" placeholder="Initiative Score (Optional)" class="bg-gray-700 text-white touch-input rounded-xl focus:ring-green-500 focus:border-green-500 border border-transparent">
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl transition duration-200 shadow-lg text-lg">
                            <i class="fas fa-user-plus"></i> Add to Initiative
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- TWO COLUMN LAYOUT: Initiative & Monster Block -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- LEFT COLUMN: Initiative List & Turn Controls -->
            <div class="container-card p-4 sm:p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-white">Initiative Order</h2>
                    <div class="space-x-3">
                        <button onclick="advanceTurn()" class="px-5 py-3 bg-yellow-600 hover:bg-yellow-700 rounded-xl text-white font-bold transition duration-200 shadow-lg text-lg">
                            <i class="fas fa-forward"></i> Next Turn
                        </button>
                        <button onclick="showClearModal()" class="px-5 py-3 bg-red-600 hover:bg-red-700 rounded-xl text-white font-bold transition duration-200 shadow-lg text-lg">
                            <i class="fas fa-trash-alt"></i> Clear
                        </button>
                    </div>
                </div>
                
                <!-- Initiative List Header for large screens -->
                <div class="hidden lg:grid grid-cols-12 gap-2 text-sm font-bold text-gray-400 mb-2 border-b border-gray-600 pb-2">
                    <div class="col-span-2 text-center">INIT</div>
                    <div class="col-span-3">NAME</div>
                    <div class="col-span-3 text-center">HP</div>
                    <div class="col-span-2 text-center">AC</div>
                    <div class="col-span-2 text-center">DELETE</div>
                </div>

                <div id="initiative-list" class="space-y-3">
                    <!-- Character rows will be dynamically inserted here -->
                    <div class="p-6 text-gray-400 text-center text-xl" id="empty-list-message">
                        No combatants added yet. Start a fight!
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: Monster Block -->
            <div class="container-card p-4 sm:p-6">
                <h2 class="text-3xl font-bold mb-4 text-red-400">Monster Stat Block Library</h2>
                
                <!-- Monster Selector -->
                <div class="mb-4">
                    <label for="monster-select" class="block text-lg font-medium text-gray-300 mb-2">Select Monster</label>
                    <select id="monster-select" onchange="handleMonsterSelection(this.value)" class="w-full bg-gray-700 text-white touch-input rounded-xl focus:ring-red-500 focus:border-red-500 border border-transparent">
                        <option value="" disabled selected>--- Choose a Monster ---</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>

                <!-- Monster Stats Display Area -->
                <div id="monster-stats-display" class="bg-gray-700 p-6 rounded-xl min-h-80 shadow-inner">
                    <p class="text-gray-400">Monster stats will appear here after selection.</p>
                </div>
                
                <!-- Quick Spawn Controls -->
                <div id="quick-spawn-controls" class="mt-6 p-5 bg-gray-600/50 rounded-xl hidden">
                    <h4 class="text-xl font-bold mb-3 text-red-300">Quick Spawn Monster(s)</h4>
                    <div class="flex space-x-3">
                        <input type="number" id="spawn-count" value="1" min="1" max="20" placeholder="Count" class="w-1/4 text-center bg-gray-700 text-white touch-input rounded-xl focus:ring-red-500 focus:border-red-500 border border-transparent">
                        <button onclick="addSelectedMonsters()" class="w-3/4 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition duration-200 shadow-lg text-xl">
                            Spawn <span id="spawn-monster-name">Monster</span>
                        </button>
                    </div>
                </div>
            </div>

        </div> <!-- END TWO COLUMN LAYOUT -->

    </div>

    <!-- Confirmation Modal Structure (Generic) -->
    <div id="modal-generic" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center p-4" aria-modal="true" role="dialog">
        <div class="bg-gray-700 p-8 rounded-2xl max-w-lg w-full shadow-2xl">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-red-400"></h3>
            <p id="modal-message" class="text-gray-200 mb-8 text-lg"></p>
            <div class="flex justify-end space-x-4">
                <button id="modal-cancel" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 rounded-xl text-white font-bold text-lg">Cancel</button>
                <button id="modal-confirm" class="px-6 py-3 bg-red-600 hover:bg-red-700 rounded-xl text-white font-bold text-lg">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Firebase Imports and Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- MONSTER DATA (Expanded for a beginner DM's library) ---
        const MONSTER_DATA = [
            // CR 0 - 1/8
            {
                name: "Bandit",
                cr: "1/8", size: "Medium", type: "Humanoid", ac: 12, hp: "11 (2d8 + 2)", speed: "30 ft.",
                stats: { str: 0, dex: 1, con: 1, int: 0, wis: 0, cha: 0 },
                actions: ["**Scimitar:** Melee Weapon Attack: +3 to hit, 5 ft., 4 (1d6 + 1) slashing."]
            },
            {
                name: "Cultist",
                cr: "1/8", size: "Medium", type: "Humanoid", ac: 12, hp: "9 (2d8)", speed: "30 ft.",
                stats: { str: 0, dex: 0, con: 0, int: 0, wis: 0, cha: 1 },
                abilities: ["**Dark Devotion:** Advantage on saves vs. charmed/frightened."],
                actions: ["**Scimitar:** Melee Weapon Attack: +3 to hit, 5 ft., 4 (1d6 + 1) slashing."]
            },
            {
                name: "Giant Rat",
                cr: "1/8", size: "Small", type: "Beast", ac: 12, hp: "7 (2d4 + 2)", speed: "30 ft.",
                stats: { str: -2, dex: 2, con: 1, int: -4, wis: 0, cha: -3 },
                abilities: ["**Keen Smell:** Advantage on Wisdom (Perception) checks that rely on smell.", "**Pack Tactics:** Advantage on an attack roll against a creature if at least one ally is within 5 ft."],
                actions: ["**Bite:** Melee Weapon Attack: +4 to hit, 5 ft., 4 (1d4 + 2) piercing."]
            },
            {
                name: "Kobold",
                cr: "1/8", size: "Small", type: "Humanoid (kobold)", ac: 12, hp: "5 (2d6 - 2)", speed: "30 ft.",
                stats: { str: -2, dex: 2, con: -2, int: -2, wis: -1, cha: -2 },
                abilities: ["**Sunlight Sensitivity:** Disadvantage on attack rolls and Perception checks when in direct sunlight.", "**Pack Tactics:** Advantage on an attack roll against a creature if at least one ally is within 5 ft."],
                actions: ["**Dagger:** Melee Weapon Attack: +4 to hit, 5 ft., 4 (1d4 + 2) piercing."]
            },
            {
                name: "Stirge",
                cr: "1/8", size: "Tiny", type: "Beast", ac: 14, hp: "2 (1d4)", speed: "10 ft., fly 40 ft.",
                stats: { str: -4, dex: 2, con: -1, int: -5, wis: -3, cha: -5 },
                actions: ["**Blood Drain:** Melee Attack: +5 to hit, 5 ft. attaches to target. While attached, the stirge doesn't attack. Instead, at the start of each of the stirge's turns, the target loses 5 (1d4 + 3) HP."]
            },
            
            // CR 1/4 - 1/2
            {
                name: "Goblin",
                cr: "1/4", size: "Small", type: "Humanoid (goblinoid)", ac: 15, hp: "7 (2d6)", speed: "30 ft.",
                stats: { str: -1, dex: 2, con: 0, int: 0, wis: -1, cha: -1 },
                abilities: ["**Nimble Escape:** The goblin can take the Disengage or Hide action as a bonus action."],
                actions: ["**Scimitar:** Melee Weapon Attack: +4 to hit, 5 ft., 5 (1d6 + 2) slashing."]
            },
            {
                name: "Skeleton",
                cr: "1/4", size: "Medium", type: "Undead", ac: 13, hp: "13 (2d8 + 4)", speed: "30 ft.",
                stats: { str: 0, dex: 2, con: 2, int: -2, wis: -1, cha: -2 },
                abilities: ["**Vulnerabilities:** Bludgeoning", "**Immunities:** Poisoned, Exhaustion, Frightened"],
                actions: ["**Shortsword:** Melee Weapon Attack: +4 to hit, 5 ft., 5 (1d6 + 2) piercing."]
            },
            {
                name: "Wolf",
                cr: "1/4", size: "Medium", type: "Beast", ac: 13, hp: "11 (2d8 + 2)", speed: "40 ft.",
                stats: { str: 1, dex: 2, con: 1, int: -4, wis: 1, cha: -2 },
                abilities: ["**Keen Hearing and Smell:** Advantage on Perception checks.", "**Pack Tactics:** Advantage on an attack roll against a creature if at least one ally is within 5 ft."],
                actions: ["**Bite:** Melee Weapon Attack: +4 to hit, 5 ft., 7 (2d4 + 2) piercing. If the target is a creature, it must succeed on a DC 11 Strength saving throw or be knocked prone."]
            },
            {
                name: "Zombie",
                cr: "1/4", size: "Medium", type: "Undead", ac: 8, hp: "22 (3d8 + 9)", speed: "20 ft.",
                stats: { str: 1, dex: -2, con: 3, int: -4, wis: -2, cha: -3 },
                abilities: ["**Undead Fortitude:** If damage reduces the zombie to 0 HP, it makes a Con save (DC 5 + damage taken) to drop to 1 HP instead."],
                actions: ["**Slam:** Melee Weapon Attack: +3 to hit, 5 ft., 4 (1d6 + 1) bludgeoning."]
            },
            {
                name: "Orc",
                cr: "1/2", size: "Medium", type: "Humanoid (orc)", ac: 13, hp: "15 (2d8 + 6)", speed: "30 ft.",
                stats: { str: 3, dex: 0, con: 3, int: -2, wis: -1, cha: -2 },
                abilities: ["**Aggressive:** Bonus action move up to speed toward a hostile creature."],
                actions: ["**Greataxe:** Melee Weapon Attack: +5 to hit, 5 ft., 9 (1d12 + 3) slashing."]
            },
            {
                name: "Flying Sword",
                cr: "1/4", size: "Medium", type: "Construct", ac: 17, hp: "17 (5d8 - 5)", speed: "0 ft., fly 50 ft.",
                stats: { str: 1, dex: 3, con: -2, int: -5, wis: -4, cha: -5 },
                abilities: ["**Blindsight:** 60 ft. (blind beyond this radius).", "**Immunities:** Poison, psychic damage; Charmed, Frightened, Paralyzed, Poisoned."],
                actions: ["**Attack:** Melee Weapon Attack: +5 to hit, 5 ft., 7 (1d8 + 3) slashing."]
            },

            // CR 1
            {
                name: "Bugbear",
                cr: "1", size: "Medium", type: "Humanoid (goblinoid)", ac: 16, hp: "27 (5d8 + 5)", speed: "30 ft.",
                stats: { str: 2, dex: 2, con: 1, int: -1, wis: 0, cha: -1 },
                abilities: ["**Surprise Attack:** Extra 7 (2d6) damage if it surprises a creature."],
                actions: ["**Morningstar:** Melee Weapon Attack: +4 to hit, 5 ft., 11 (2d8 + 2) piercing."]
            },
            {
                name: "Ghoul",
                cr: "1", size: "Medium", type: "Undead", ac: 12, hp: "22 (5d8)", speed: "30 ft.",
                stats: { str: 1, dex: 2, con: 0, int: -2, wis: 0, cha: -2 },
                abilities: ["**Immunities:** Charmed, Exhaustion, Poisoned."],
                actions: ["**Claws:** Melee Attack: +4 to hit, 5 ft., 7 (2d4 + 2) slashing. Target must succeed on a DC 10 Con save or be paralyzed for 1 min."]
            },
            {
                name: "Gnoll",
                cr: "1/2", size: "Medium", type: "Humanoid (gnoll)", ac: 15, hp: "22 (5d8)", speed: "30 ft.",
                stats: { str: 2, dex: 1, con: 0, int: -2, wis: 0, cha: -1 },
                abilities: ["**Rampage:** When the gnoll reduces a creature to 0 HP with a melee attack on its turn, the gnoll can take a bonus action to move up to half its speed and make a bite attack."],
                actions: ["**Bite:** Melee Weapon Attack: +4 to hit, 5 ft., 4 (1d4 + 2) piercing.", "**Spear:** Melee or Ranged Weapon Attack: +4 to hit, 5 ft. or range 20/60 ft., 5 (1d6 + 2) piercing."]
            },
            {
                name: "Giant Spider",
                cr: "1", size: "Large", type: "Beast", ac: 14, hp: "26 (4d10 + 4)", speed: "30 ft., climb 30 ft.",
                stats: { str: 1, dex: 3, con: 1, int: -4, wis: 0, cha: -2 },
                abilities: ["**Web Sense/Walker:** Knows exactly where other creatures are in contact with its web. Ignores movement restrictions caused by webbing."],
                actions: ["**Bite:** Melee Attack: +5 to hit, 5 ft., 7 (1d8 + 3) piercing damage plus 7 (2d6) poison damage. Target must succeed on a DC 11 Con save or take half poison damage."]
            }
        ];

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let userId = null;
        const COLLECTION_ID = 'initiative_list';
        const DOCUMENT_ID = 'initiative_data';

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const loadingOverlay = document.getElementById('loading-overlay');
        const listContainer = document.getElementById('initiative-list');
        const emptyMessage = document.getElementById('empty-list-message');
        const userIdDisplay = document.getElementById('user-id-display');
        const monsterSelect = document.getElementById('monster-select');
        const monsterStatsDisplay = document.getElementById('monster-stats-display');
        const quickSpawnControls = document.getElementById('quick-spawn-controls');

        // --- Core Application State Management ---

        let characters = [];
        let currentTurnIndex = 0; // Index of the combatant currently active in the *sorted* list

        /** Generates a secure, random ID. */
        const generateId = () => crypto.randomUUID();

        /** Constructs the Firestore document path. */
        const getDocRef = () => doc(db, 'artifacts', appId, 'users', userId, COLLECTION_ID, DOCUMENT_ID);

        /** Saves the current state (characters and turn index) to Firestore. */
        const saveState = async () => {
            if (!db || !userId) {
                console.error("Firestore not initialized or userId missing.");
                return;
            }
            try {
                // Remove objects that might be empty or invalid before saving
                await setDoc(getDocRef(), { 
                    characters: characters.filter(c => c && c.name), 
                    currentTurnIndex: currentTurnIndex 
                });
            } catch (error) {
                console.error("Error saving document: ", error);
            }
        };

        /** Renders the entire initiative list based on the current state. */
        const renderList = () => {
            const sortedCharacters = characters.sort((a, b) => {
                const initA = parseInt(a.initiative) || -99;
                const initB = parseInt(b.initiative) || -99;

                if (initA !== initB) {
                    return initB - initA; // Sort by initiative descending
                }

                // Secondary sort by name ascending if initiative is the same
                return a.name.localeCompare(b.name);
            });

            listContainer.innerHTML = sortedCharacters.map((char, index) => {
                const isCurrentTurn = index === currentTurnIndex && sortedCharacters.length > 0;
                return renderCharacterRow(char, isCurrentTurn);
            }).join('');

            if (characters.length === 0) {
                emptyMessage.style.display = 'block';
                quickSpawnControls.classList.add('hidden'); 
            } else {
                emptyMessage.style.display = 'none';
                // Highlight the row if the selected monster is ready to spawn
                if (selectedMonsterName) quickSpawnControls.classList.remove('hidden');
            }
        };

        /** Converts characters data into an HTML list item. */
        const renderCharacterRow = (character, isCurrentTurn) => {
            const isPlayer = character.isPlayer || false;
            let cardBg = isPlayer ? 'bg-green-900/40 hover:bg-green-900/60' : 'bg-gray-800/40 hover:bg-gray-800/60';
            const nameColor = isPlayer ? 'text-green-300 font-extrabold' : 'text-white font-semibold';
            const hpColor = character.currentHp <= 0 ? 'text-red-400 font-extrabold' : 'text-green-400 font-extrabold';
            const acColor = isPlayer ? 'text-green-200' : 'text-gray-300';
            const initColor = isCurrentTurn ? 'text-yellow-200' : 'text-yellow-400';

            if (isCurrentTurn) {
                cardBg += ' current-turn-highlight';
            }

            return `
                <div id="row-${character.id}" data-id="${character.id}" class="grid grid-cols-12 gap-1 lg:gap-2 p-3 ${cardBg} rounded-xl items-center transition duration-150">
                    <!-- Initiative (Col 1-2) -->
                    <div class="col-span-2 text-center">
                        <input type="number" value="${character.initiative || ''}" placeholder="Roll" data-field="initiative"
                               class="w-full text-center bg-gray-900/70 ${initColor} font-extrabold p-2 rounded-lg text-lg touch-input border border-transparent"
                               onchange="updateField('${character.id}', 'initiative', this.value)" />
                    </div>

                    <!-- Name (Col 3-4 on mobile, 3-5 on tablet/desktop) -->
                    <div class="col-span-3 truncate pl-2">
                        <p class="${nameColor} text-lg">${character.name}</p>
                        ${isPlayer ? '<p class="text-xs text-green-500/70">PC</p>' : ''}
                    </div>

                    <!-- HP (Col 6-8) -->
                    <div class="col-span-3 flex items-center space-x-1 sm:space-x-2">
                        <button onclick="changeHP('${character.id}', -1)" class="hp-button bg-red-600 hover:bg-red-700 rounded-full text-white text-md flex items-center justify-center">-</button>
                        <input type="number" value="${character.currentHp}" data-field="currentHp"
                               class="w-full text-center bg-gray-900/70 ${hpColor} p-1 rounded-lg text-xl touch-input border border-transparent"
                               onchange="updateField('${character.id}', 'currentHp', this.value)" />
                        <button onclick="changeHP('${character.id}', 1)" class="hp-button bg-green-600 hover:bg-green-700 rounded-full text-white text-md flex items-center justify-center">+</button>
                    </div>

                    <!-- AC (Col 9-10) -->
                    <div class="col-span-2 text-center">
                        <input type="number" value="${character.ac}" placeholder="AC" data-field="ac"
                               class="w-full text-center bg-gray-900/70 ${acColor} p-2 rounded-lg text-lg touch-input border border-transparent"
                               onchange="updateField('${character.id}', 'ac', this.value)" />
                    </div>

                    <!-- Delete (Col 11-12) -->
                    <div class="col-span-2 text-center">
                        <button onclick="showDeleteModal('${character.id}', '${character.name}')" class="text-red-400 hover:text-red-500 p-2 rounded-full transition duration-150 text-xl">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `;
        };

        // --- Dice/HP Rolling Utilities ---

        /** Simple D-side die roll. */
        const rollDie = (sides) => Math.floor(Math.random() * sides) + 1;
        
        /**
         * Parses and rolls HP from a string like "2d8 + 2" or "30".
         */
        const parseAndRollHP = (hpString) => {
            const simpleMatch = hpString.match(/^\s*(\d+)\s*$/);
            if (simpleMatch) return parseInt(simpleMatch[1]);
            
            const diceMatch = hpString.match(/(\d+)d(\d+)\s*([+\-]\s*\d+)?/);
            
            if (diceMatch) {
                const numDice = parseInt(diceMatch[1]);
                const sides = parseInt(diceMatch[2]);
                // Ensure modifier is parsed correctly (e.g., handles " + 2" or " - 1")
                const modifierStr = diceMatch[3] ? diceMatch[3].replace(/\s/g, '') : '0';
                const modifier = parseInt(modifierStr);
                
                let totalHp = modifier;
                for (let i = 0; i < numDice; i++) {
                    totalHp += rollDie(sides);
                }
                return Math.max(1, totalHp); // Minimum 1 HP
            }
            
            const fallbackMatch = hpString.match(/\d+/);
            if (fallbackMatch) return parseInt(fallbackMatch[0]);

            return 1;
        };

        // --- Character Manipulation ---

        /**
         * Adds a new character to the local array and saves to Firestore.
         */
        const addCharacter = (name, hp, ac, initiative, isPlayer = false) => {
            const newChar = {
                id: generateId(),
                name: name.trim(),
                currentHp: parseInt(hp) || 0,
                ac: parseInt(ac) || 0,
                // Null for empty initiative allows for sorting to place them last if not yet rolled
                initiative: initiative === '' ? null : (parseInt(initiative) || null),
                isPlayer: isPlayer
            };

            characters = [...characters, newChar];
            renderList();
            saveState();
        };

        /** Adds one or more monsters based on the currently selected stat block. */
        window.addSelectedMonsters = () => {
            const monsterName = monsterSelect.value;
            const count = parseInt(document.getElementById('spawn-count').value) || 1;
            const monster = MONSTER_DATA.find(m => m.name === monsterName);

            if (!monster) return;

            // Find the highest existing number for this monster type
            const existingMonsters = characters.filter(c => c.name.startsWith(monsterName)).length;
            let monsterIndex = 0;

            // Start naming from the highest existing number + 1
            if (existingMonsters > 0) {
                 const nameParts = characters
                    .filter(c => c.name.startsWith(monsterName) && !isNaN(parseInt(c.name.split(' ').pop())))
                    .map(c => parseInt(c.name.split(' ').pop()))
                    .filter(n => !isNaN(n));
                 
                monsterIndex = nameParts.length > 0 ? Math.max(...nameParts) : 0;
            }


            // Extract HP formula (e.g., "2d8 + 2") from the full HP string
            const hpMatch = monster.hp.match(/\((.*?)\)/);
            const hpFormula = hpMatch ? hpMatch[1].trim() : monster.hp;
            
            // Get DEX modifier. Stats are stored as integers (e.g., 1, 2, 3...)
            const dexMod = monster.stats.dex;

            for (let i = 0; i < count; i++) {
                monsterIndex++;
                const name = `${monsterName} ${monsterIndex}`;
                
                // Roll HP based on the formula
                const hp = parseAndRollHP(hpFormula); 
                
                // Roll Initiative (d20 + DEX modifier)
                const initiative = rollDie(20) + (dexMod || 0);

                const newMonster = {
                    id: generateId(),
                    name: name,
                    currentHp: hp,
                    ac: monster.ac,
                    initiative: initiative,
                    isPlayer: false // NPCs/Monsters
                };
                characters.push(newMonster);
            }

            renderList();
            saveState();
            
            // Reset spawn count to 1 after successful spawning
            document.getElementById('spawn-count').value = 1;
        };


        /** Deletes a character by ID. */
        window.deleteCharacter = (id) => {
            characters = characters.filter(char => char.id !== id);
            
            // Recalculate turn index
            if (currentTurnIndex >= characters.length) {
                currentTurnIndex = Math.max(0, characters.length - 1);
            }

            renderList();
            saveState();
        };

        /** Updates a specific field (HP, AC, Initiative) of a character. */
        window.updateField = (id, field, value) => {
            const index = characters.findIndex(char => char.id === id);
            if (index !== -1) {
                let parsedValue = ['initiative', 'currentHp', 'ac'].includes(field) ? (parseInt(value) || 0) : value;

                if (field === 'initiative' && (value === '' || value === null)) {
                    parsedValue = null;
                }

                characters[index][field] = parsedValue;
                renderList(); 
                saveState();
            }
        };

        /** Changes HP by a specific amount (+/-). */
        window.changeHP = (id, amount) => {
            const char = characters.find(c => c.id === id);
            if (char) {
                const newHp = (char.currentHp || 0) + amount;
                window.updateField(id, 'currentHp', newHp);
            }
        };

        // --- Turn Tracking Logic ---

        window.advanceTurn = () => {
            if (characters.length === 0) return;
            
            // Get the list sorted the same way as renderList()
            const sortedCharacters = characters.sort((a, b) => {
                const initA = parseInt(a.initiative) || -99;
                const initB = parseInt(b.initiative) || -99;
                if (initA !== initB) return initB - initA;
                return a.name.localeCompare(b.name);
            });

            // If the current list is empty, reset
            if (sortedCharacters.length === 0) {
                 currentTurnIndex = 0;
            } else {
                 // Advance the index, wrapping around to the start
                 currentTurnIndex = (currentTurnIndex + 1) % sortedCharacters.length;
            }
            
            renderList();
            saveState();
        };

        window.clearEncounter = () => {
            characters = [];
            currentTurnIndex = 0;
            renderList();
            saveState();
            hideModal();
        };
        
        // --- D20 Roller Logic ---

        const d20Roller = document.getElementById('d20-roller');
        const d20ResultText = document.getElementById('d20-result-text');

        window.rollD20 = () => {
            const result = rollDie(20);
            d20Roller.textContent = result;
            
            // Apply color based on result
            let bgColor = 'bg-green-600';
            let textColor = 'text-white';

            if (result === 20) {
                bgColor = 'bg-yellow-400';
                textColor = 'text-gray-900';
            } else if (result === 1) {
                bgColor = 'bg-red-600';
            }

            d20Roller.className = `d20 d20-face ${bgColor} hover:${bgColor.replace('bg-', 'bg-')} w-40 h-40 flex items-center justify-center ${textColor} font-extrabold text-7xl shadow-xl transition-all duration-300 transform hover:scale-105`;

            d20ResultText.textContent = `Last Roll: ${result}`;
        };

        // --- Monster Stat Block Logic ---

        /** Populates the monster selection dropdown. */
        const populateMonsterSelector = () => {
            const sortedMonsters = MONSTER_DATA.sort((a, b) => a.name.localeCompare(b.name));
            sortedMonsters.forEach(monster => {
                const option = document.createElement('option');
                option.value = monster.name;
                option.textContent = `${monster.name} (CR ${monster.cr})`;
                monsterSelect.appendChild(option);
            });
        };

        let selectedMonsterName = null;

        /** Formats and displays the selected monster's stat block. */
        window.handleMonsterSelection = (monsterName) => {
            const monster = MONSTER_DATA.find(m => m.name === monsterName);
            selectedMonsterName = monsterName;
            
            if (!monster) {
                monsterStatsDisplay.innerHTML = '<p class="text-gray-400">Monster not found.</p>';
                quickSpawnControls.classList.add('hidden');
                return;
            }

            // Function to format the modifier
            const formatMod = (score) => {
                const mod = Math.floor((score - 10) / 2);
                return mod >= 0 ? `+${mod}` : `${mod}`;
            };
            
            // Stat Block HTML generation
            const stats = monster.stats;
            const statBlockHtml = `
                <div class="text-white">
                    <h3 class="text-3xl font-extrabold text-red-300 mb-1">${monster.name}</h3>
                    <p class="text-base italic mb-3">${monster.size} ${monster.type}, Challenge ${monster.cr}</p>
                    <div class="stat-divider"></div>

                    <div class="text-lg space-y-2">
                        <p><span class="font-bold text-red-200">AC:</span> ${monster.ac}</p>
                        <p><span class="font-bold text-red-200">HP:</span> ${monster.hp}</p>
                        <p><span class="font-bold text-red-200">Speed:</span> ${monster.speed}</p>
                    </div>

                    <div class="stat-divider"></div>
                    
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-6 gap-2 text-center text-lg font-bold mb-4">
                        <div class="bg-gray-800/70 p-2 rounded-lg">STR<br/><span class="text-red-300">${formatMod(stats.str + 10)}</span></div>
                        <div class="bg-gray-800/70 p-2 rounded-lg">DEX<br/><span class="text-red-300">${formatMod(stats.dex + 10)}</span></div>
                        <div class="bg-gray-800/70 p-2 rounded-lg">CON<br/><span class="text-red-300">${formatMod(stats.con + 10)}</span></div>
                        <div class="bg-gray-800/70 p-2 rounded-lg">INT<br/><span class="text-red-300">${formatMod(stats.int + 10)}</span></div>
                        <div class="bg-gray-800/70 p-2 rounded-lg">WIS<br/><span class="text-red-300">${formatMod(stats.wis + 10)}</span></div>
                        <div class="bg-gray-800/70 p-2 rounded-lg">CHA<br/><span class="text-red-300">${formatMod(stats.cha + 10)}</span></div>
                    </div>
                    <div class="stat-divider"></div>

                    <!-- Abilities -->
                    ${(monster.abilities || []).length > 0 ? `
                        <h4 class="text-xl font-bold mt-4 mb-2 text-red-300">Traits</h4>
                        ${monster.abilities.map(ability => `<p class="text-base mb-2">${ability}</p>`).join('')}
                        <div class="stat-divider"></div>
                    ` : ''}


                    <!-- Actions -->
                    ${(monster.actions || []).length > 0 ? `
                        <h4 class="text-xl font-bold mt-4 mb-2 text-red-300">Actions</h4>
                        ${monster.actions.map(action => `<p class="text-base mb-2">${action}</p>`).join('')}
                    ` : ''}

                </div>
            `;

            monsterStatsDisplay.innerHTML = statBlockHtml;
            document.getElementById('spawn-monster-name').textContent = monster.name;
            quickSpawnControls.classList.remove('hidden');
        };


        // --- Modal/UI Management ---

        const modalGeneric = document.getElementById('modal-generic');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalCancel = document.getElementById('modal-cancel');

        const hideModal = () => {
            modalGeneric.classList.remove('flex');
            modalGeneric.classList.add('hidden');
            modalConfirm.onclick = null; // Clear handler
        };

        window.showDeleteModal = (id, name) => {
            modalTitle.textContent = "Confirm Deletion";
            modalMessage.innerHTML = `Are you sure you want to remove <span class="font-semibold text-white">${name}</span> from the encounter?`;
            modalConfirm.textContent = "Delete";
            modalGeneric.classList.remove('hidden');
            modalGeneric.classList.add('flex');
            
            modalConfirm.onclick = () => {
                window.deleteCharacter(id);
                hideModal();
            };
            modalCancel.onclick = hideModal;
        };
        
        window.showClearModal = () => {
            if (characters.length === 0) return;
            
            modalTitle.textContent = "Clear Encounter";
            modalMessage.innerHTML = `Are you sure you want to remove **ALL** ${characters.length} combatants and reset the encounter? This cannot be undone.`;
            modalConfirm.textContent = "Clear All";
            modalGeneric.classList.remove('hidden');
            modalGeneric.classList.add('flex');
            
            modalConfirm.onclick = window.clearEncounter;
            modalCancel.onclick = hideModal;
        };


        // --- Form Submission ---

        document.getElementById('add-character-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const name = document.getElementById('char-name').value;
            const hp = document.getElementById('char-hp').value;
            const ac = document.getElementById('char-ac').value;
            const initiative = document.getElementById('char-initiative').value;

            if (name && hp && ac) {
                addCharacter(name, hp, ac, initiative, true); 

                // Clear the form fields
                document.getElementById('char-name').value = '';
                document.getElementById('char-hp').value = '';
                document.getElementById('char-ac').value = '';
                document.getElementById('char-initiative').value = '';
            }
        });

        // --- Firebase Initialization and Real-time Listener ---

        const initFirebase = async () => {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                loadingOverlay.classList.add('hidden');
                return;
            }

            try {
                // 1. Initialize App and Services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 2. Authenticate the User
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 3. Set up Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `Collaboration ID: ${userId.substring(0, 8)}... (Share for co-DMing)`;

                        // 4. Start Real-time Data Listener
                        const docRef = getDocRef();

                        onSnapshot(docRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                characters = data.characters || [];
                                currentTurnIndex = data.currentTurnIndex || 0;
                                
                                // Ensure turn index is within bounds after data load
                                if (currentTurnIndex >= characters.length && characters.length > 0) {
                                    currentTurnIndex = 0;
                                } else if (characters.length === 0) {
                                    currentTurnIndex = 0;
                                }

                            } else {
                                // Document doesn't exist, create it with initial state
                                if (characters.length === 0) {
                                    setDoc(docRef, { characters: [], currentTurnIndex: 0 }, { merge: true }).catch(e => console.error("Error creating initial document:", e));
                                }
                            }
                            renderList();
                            loadingOverlay.classList.add('hidden');

                        }, (error) => {
                            console.error("Error listening to Firestore changes:", error);
                            loadingOverlay.classList.add('hidden');
                        });

                    } else {
                        userId = null;
                        loadingOverlay.classList.add('hidden');
                    }
                });

            } catch (error) {
                console.error("Critical error during Firebase setup:", error);
                loadingOverlay.classList.add('hidden');
            }
        };

        // Initialize on window load
        window.onload = () => {
            populateMonsterSelector();
            initFirebase();
        }
    </script>

</body>
</html>
